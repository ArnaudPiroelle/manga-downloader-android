machine:
  java:
    version: oraclejdk8

dependencies:
  pre:
    - echo y | android update sdk --no-ui --all --filter platform-tools,build-tools-22.0.1,android-22,sys-img-armeabi-v7a-android-22,extra-google-m2repository,extra-android-m2repository,extra-android-support

test:
  pre:
    - emulator -avd circleci-android22 -no-audio -no-window:
        background: true
        parallel: true
  override:
    - TERM=dumb ./gradlew testMockDebug
    - mkdir -p  $CIRCLE_TEST_REPORTS/unit && cp -r app/build/test-results/mockDebug/* $CIRCLE_TEST_REPORTS/unit
    - circle-android wait-for-boot
    - TERM=dumb ./gradlew spoonRealDebugAndroidTest

deployment:
  develop:
    branch: develop
    commands:
      - cp -r app/build/reports/tests/mockDebug $CIRCLE_ARTIFACTS
      - mkdir -p $CIRCLE_TEST_REPORTS/spoon && cp -r app/build/spoon/real/debug/* $CIRCLE_TEST_REPORTS/spoon

  production:
    branch: master
    commands:
      - echo "apiSecret=$FABRIC_API_SECRET" > app/fabric.properties
      - TERM=dumb ./gradlew assembleRealRelease crashlyticsUploadDistributionRealRelease -PdisablePreDex
